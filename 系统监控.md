# 系统监控

参考资料:  
[Elastic Stack 中文指南](https://elkguide.elasticsearch.cn/)

架构技术选型：

+ **日志监控 ELK**

  + ++日志收集 Scribe、Fluent、Flume、Logstash、Rsyslog、Scripts++
    
    + Fluent
    + Logstash
    
  + ++日志汇总 Kafka++

    > 1、分布式架构，可支持水平扩展。  
    > 2、高吞吐量，在普通的服务器上每秒钟也能处理几十万条消息。  
    > 3、消息持久化，按topic分区存储，支持可重复消费。  
    > 4、日志系统不需要保证严格的消息准确性。  
    > 5、数据在磁盘上的存取代价为O(1)。  
    > 6、可根据broker配置定期删除过期数据。

  + ++日志处理 Logstash++

    功能包括：数据采集、输入、过滤、输出。
    适用于各种形式和大小的数据。   

    暂时研究的问题：  
    1) 如何创建pipeline，以Apache日志作为输入，将日志解析成结构化数据并存储到ES集群？
    2) 如何结合多个输入输出插件实现对不同来源的数据的合并？
    
    > Metrics 指的是什么？  
    > event ?  
    > pipeline 应该怎么理解？

  + ++日志存储 Elasticsearch++

  + ++日志数据可视化 Kibana++

+ **系统资源监控 cAdvisor+Prometheus+influxdb+grafana**
  
  参考：[uschtwill/docker_monitoring_logging_alerting](https://github.com/uschtwill/docker_monitoring_logging_alerting)

  + ++容器监控 cAdvisor++

    cadvisor不仅可以搜集一台机器上所有运行的容器信息，还提供基础查询界面和http接口，方便其他组件如Prometheus进行数据抓取

  + ++Prometheus++

    Prometheus 是由 SoundCloud 开源监控告警解决方案；存储的是时序数据，即按相同时序(相同名称和标签)，以时间维度存储连续的数据的集合。

    - AlertManager

      Prometheus自带的报警组件。

  + ++influxdb++

    时序数据库

  + ++Grafana++

+ **监控报警**
  
  + ++Zabbix++

参考架构：
![](https://afoo.me/columns/tec/images/logging-platform.png)


服务1/2/3/... -> 日志采集工具 -> kafka/rocketmq -> logstash -> Elasticsearch -> Kibana

## Logstash

[Logstash Refernce](https://www.elastic.co/guide/en/logstash/current/index.html)

### 工作原理

#### 四个组件

包含三个阶段：输入->过滤->输出。

**输入器（可以通过input-plugins拓展）**：
file、syslog、redis、beats ...   
[input-plugins](https://www.elastic.co/guide/en/logstash/current/input-plugins.html)  
本来打算使用logback打日志的，但是官方没有提供对应的input插件。TODO：?

+ kafka

**过滤器（不单单是过滤的功能,可以组合使用，可通过filter-plugins拓展）**：
grok、mutate、drop、clone、geoip ...  
[filter-plugins](https://www.elastic.co/guide/en/logstash/current/filter-plugins.html)

+ grok（logstash-filter-grok）

  将非结构化事件数据解析为字段

+ json

**输出器（将处理后的数据输出到指定的存储，可通过output-plugins拓展）**：
elasticsearch、file、graphite、statsd ...  
[output-plugins](https://www.elastic.co/guide/en/logstash/current/output-plugins.html)

+ elasticsearch

+ email

+ influxdb

+ zabbix

**编解码器（在input之前和output之后起作用，可通过codec-plugins拓展）**:  
json、multiline ...  
[codec-plugins](https://www.elastic.co/guide/en/logstash/current/codec-plugins.html)

+ json

#### 执行模型

没有找到详细的图，下面这个图相对还行。  
但是需要补充一下：图中filter可不是一个，而是一个filter链。
![](https://img-blog.csdn.net/20180714153238934?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM1OTMwMjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

Logstash事件处理管道

队列事件持久化（防止事件丢失）
[Persistent Queues](https://www.elastic.co/guide/en/logstash/current/persistent-queues.html)

### 安装运行

#### 配置

+ logstash.yml

+ pipeline.yml

+ jvm.options

+ log4j2.properties

+ startup.options

#### Docker容器运行（单机）

```
#测试启动
docker run --rm -it logstash:7.5.1
#生产部署（把需要配置的文件映射到本地）
docker run -di 
  --name logstash-single
  -v /home/lee/docker/logstash/log:/var/log/logstash
  logstash:7.5.1
```



### 模块/插件集成

+ X-Pack（默认安装）

  Elastic stack 的拓展，提供安全、报警、监控、机器学习、pipeline管理等功能。
  是默认安装的。

+ Filebeat

  ![Filebeat工作原理简图](https://www.elastic.co/guide/en/beats/filebeat/current/images/filebeat.png)


